<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒˆã‚¿ãƒ¯ãƒ¼ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  | IoT Factory Dashboard</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Custom IoT Factory CSS -->
    <link rel="stylesheet" href="/static/css/iot-factory.css">

    <style>
        /* è¿½åŠ ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º */
        .timeline-container {
            margin-top: 15px;
        }

        .timeline-label {
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 3px;
            color: var(--text-secondary);
        }

        .timeline-bar {
            display: flex;
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }

        .timeline-segment {
            position: relative;
            transition: opacity 0.2s;
        }

        .timeline-segment:hover {
            opacity: 0.8;
            cursor: pointer;
        }

        .timeline-segment.green {
            background-color: var(--status-running);
        }

        .timeline-segment.yellow {
            background-color: var(--status-warning);
        }

        .timeline-segment.red {
            background-color: var(--status-stop);
        }

        .timeline-segment.gray {
            background-color: var(--status-idle);
        }

        .timeline-segment.white {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
        }

        /* ãƒãƒƒãƒ†ãƒªãƒ¼è‰² */
        .battery-high {
            color: var(--status-running);
        }

        .battery-medium {
            color: var(--status-warning);
        }

        .battery-low {
            color: var(--status-stop);
        }

        /* æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„ */
        input[type="date"] {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        input[type="date"]:hover {
            border-color: var(--text-cyan);
            box-shadow: 0 0 0 0.2rem rgba(0, 255, 255, 0.1);
        }

        input[type="date"]:focus {
            border-color: var(--text-cyan);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 255, 255, 0.2);
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è¦–èªæ€§å‘ä¸Š */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(1);
            opacity: 0.8;
            width: 20px;
            height: 20px;
            padding: 2px;
            background-color: rgba(0, 255, 255, 0.1);
            border-radius: 4px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
            background-color: rgba(0, 255, 255, 0.2);
        }
    </style>
</head>

<body>
    <!-- ãƒ¢ãƒ€ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header-modern">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="header-title">
                        <i class="bi bi-broadcast-pin"></i> No RUNNING, No HARVEST ï½ç¨¼åƒãªã—ã«åç©«ãªã—ï½
                    </h1>
                    <p class="header-subtitle">ãƒ©ã‚¤ãƒˆã‚¿ãƒ¯ãƒ¼ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨­å‚™ç¨¼åƒç®¡ç†</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end align-items-center gap-2 mt-3 mt-md-0 flex-wrap">
                        <!-- GreenAppleç²å¾—æ•° -->
                        <div class="green-apple-container">
                            <span class="green-apple-label">æœ¬æ—¥ã®GREEN APPLEåç©«é‡</span>
                            <div class="green-apple-display" id="GreenAppleDisplay">
                                <!-- ãƒªãƒ³ã‚´ã‚¢ã‚¤ã‚³ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                            </div>
                        </div>

                        <!-- æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                        <div class="connection-status-badge">
                            <span id="connectionBadge">
                                <i class="bi bi-wifi-off"></i> æœªæ¥ç¶š
                            </span>
                        </div>

                        <!-- åˆ—æ•°é¸æŠ -->
                        <div class="column-selector">
                            <button class="btn-icon" onclick="setColumns(2)" id="col-2" title="2åˆ—è¡¨ç¤º">
                                <i class="bi bi-grid-3x2"></i>
                            </button>
                            <button class="btn-icon active" onclick="setColumns(3)" id="col-3" title="3åˆ—è¡¨ç¤º">
                                <i class="bi bi-grid-3x3"></i>
                            </button>
                            <button class="btn-icon" onclick="setColumns(4)" id="col-4" title="4åˆ—è¡¨ç¤º">
                                <i class="bi bi-grid"></i>
                            </button>
                            <button class="btn-icon" onclick="setColumns(5)" id="col-5" title="5åˆ—ç°¡æ˜“è¡¨ç¤º">
                                <i class="bi bi-grid-1x2"></i>
                            </button>
                        </div>

                        <button class="btn-icon" onclick="toggleFullscreen()" id="fullscreenBtn" title="å…¨ç”»é¢è¡¨ç¤º">
                            <i class="bi bi-arrows-fullscreen" id="fullscreenIcon"></i>
                        </button>

                        <button class="btn-modern" onclick="showDeviceManagement()">
                            <i class="bi bi-gear"></i> ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†
                        </button>

                        <span class="text-secondary" id="currentTime" style="font-size: 0.9rem;"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid mt-4">
        <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
        <div class="row mb-4 g-3">
            <div class="col">
                <div class="device-card text-center">
                    <div class="text-cyan" style="font-size: 2rem;"><i class="bi bi-hdd-network"></i></div>
                    <div class="operation-rate-title mt-2">æ¥ç¶šãƒ‡ãƒã‚¤ã‚¹</div>
                    <h2 id="deviceCount" class="text-cyan" style="font-size: 2.5rem; font-weight: 700;">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="device-card text-center">
                    <div style="font-size: 2rem; color: var(--status-running);"><i class="bi bi-play-circle"></i></div>
                    <div class="operation-rate-title mt-2">ç¨¼åƒä¸­</div>
                    <h2 id="runningCount" style="font-size: 2.5rem; font-weight: 700; color: var(--status-running);">0
                    </h2>
                </div>
            </div>
            <div class="col">
                <div class="device-card text-center">
                    <div style="font-size: 2rem; color: var(--status-warning);"><i class="bi bi-pause-circle"></i></div>
                    <div class="operation-rate-title mt-2">åœæ­¢ä¸­(é»„)</div>
                    <h2 id="warningCount" style="font-size: 2.5rem; font-weight: 700; color: var(--status-warning);">0
                    </h2>
                </div>
            </div>
            <div class="col">
                <div class="device-card text-center">
                    <div style="font-size: 2rem; color: var(--status-stop);"><i class="bi bi-stop-circle"></i></div>
                    <div class="operation-rate-title mt-2">åœæ­¢ä¸­(èµ¤)</div>
                    <h2 id="errorCount" style="font-size: 2.5rem; font-weight: 700; color: var(--status-stop);">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="device-card text-center">
                    <div style="font-size: 2rem; color: var(--status-idle);"><i class="bi bi-dash-circle"></i></div>
                    <div class="operation-rate-title mt-2">ä¼‘æ­¢ä¸­</div>
                    <h2 id="noneCount" style="font-size: 2.5rem; font-weight: 700; color: var(--status-idle);">0</h2>
                </div>
            </div>
        </div>

        <!-- ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ -->
        <div class="row">
            <div class="col-12 mb-3">
                <h3 class="text-cyan text-glow">
                    <i class="bi bi-buildings"></i> è¨­å‚™ç¨¼åƒçŠ¶æ³ï¼ˆå…¨7å°ï¼‰
                </h3>
            </div>
            <div class="col-12">
                <div id="deviceList" class="row g-3">
                    <!-- ãƒ‡ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    <div class="col-12 text-center py-5" id="loadingMessage">
                        <div class="spinner-border text-cyan" role="status">
                            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                        <p class="mt-2 text-secondary">ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨ä½“ç¨¼åƒç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="row mt-4 g-3">
            <!-- ç¾åœ¨ã®å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰ -->
            <div class="col-md-4">
                <div class="device-card">
                    <h5 class="text-cyan mb-3">
                        <i class="bi bi-pie-chart"></i> å…¨ä½“ç¨¼åƒçŠ¶æ³ï¼ˆæœ¬æ—¥ 6:00ï½ç¾åœ¨ã®ç¨¼åƒæ™‚é–“å‰²åˆï¼‰
                    </h5>
                    <div class="chart-container">
                        <canvas id="overallStatusChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- æ™‚é–“å¸¯åˆ¥ç¨¼åƒæ¨ç§»ï¼ˆç©ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼‰ -->
            <div class="col-md-8">
                <div class="device-card">
                    <h5 class="text-cyan mb-3">
                        <i class="bi bi-bar-chart"></i> æ™‚é–“å¸¯åˆ¥ç¨¼åƒæ¨ç§»ï¼ˆç¨¼åƒæ™‚é–“å‰²åˆ - æœ¬æ—¥ 6:00ï½ï¼‰
                    </h5>
                    <div class="chart-container">
                        <canvas id="hourlyStatusChart"></canvas>
                    </div>

                    <!-- GREEN APPLEåç©«ãƒ«ãƒ¼ãƒ« -->
                    <div class="apple-harvest-rules mt-3">
                        <div class="rules-title">
                            <i class="bi bi-award"></i> GREEN APPLEåç©«æ¡ä»¶ï¼ˆå„æ™‚é–“å¸¯ã”ã¨ã«é©ç”¨ï¼‰
                        </div>
                        <div class="rules-grid">
                            <div class="rule-item rule-ok">
                                <span class="rule-condition">ç¨¼åƒç‡ 30%è¶…</span>
                                <span class="rule-reward">ğŸ</span>
                            </div>
                            <div class="rule-item rule-good">
                                <span class="rule-condition">ç¨¼åƒç‡ 35%ä»¥ä¸Š</span>
                                <span class="rule-reward">ğŸğŸ</span>
                            </div>
                            <div class="rule-item rule-great">
                                <span class="rule-condition">ç¨¼åƒç‡ 40%ä»¥ä¸Š</span>
                                <span class="rule-reward">ğŸğŸğŸ</span>
                            </div>
                            <div class="rule-item rule-excellent">
                                <span class="rule-condition">ç¨¼åƒç‡ 50%ä»¥ä¸Š</span>
                                <span class="rule-reward">ğŸğŸğŸğŸğŸ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¨¼åƒç‡æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰ -->
        <div class="row mt-3 g-3">
            <div class="col-12">
                <div class="device-card">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h5 class="text-cyan mb-0">
                            <i class="bi bi-graph-up"></i> ç¨¼åƒç‡æ¨ç§»
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <label class="text-muted small mb-0">æœŸé–“:</label>
                            <input type="date" id="operationStartDate" class="form-control form-control-sm"
                                style="width: auto;" onchange="updateMonthlyCharts()">
                            <span class="text-muted">ã€œ</span>
                            <input type="date" id="operationEndDate" class="form-control form-control-sm"
                                style="width: auto;" onchange="updateMonthlyCharts()">
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyOperationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- GreenAppleåç©«é‡ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰ -->
        <div class="row mt-3 g-3">
            <div class="col-12">
                <div class="device-card">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h5 class="text-cyan mb-0">
                            <i class="bi bi-bar-chart-fill"></i> GREEN APPLEåç©«é‡
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <label class="text-muted small mb-0">æœŸé–“:</label>
                            <input type="date" id="appleStartDate" class="form-control form-control-sm"
                                style="width: auto;" onchange="updateMonthlyCharts()">
                            <span class="text-muted">ã€œ</span>
                            <input type="date" id="appleEndDate" class="form-control form-control-sm"
                                style="width: auto;" onchange="updateMonthlyCharts()">
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyGreenAppleChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="deviceManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="btn-modern mb-3" onclick="showAddDeviceForm()">
                        <i class="bi bi-plus-circle"></i> æ–°è¦ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ 
                    </button>

                    <!-- ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>MACã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th>è¨­å‚™å</th>
                                    <th>è¨­ç½®å ´æ‰€</th>
                                    <th>èª¬æ˜</th>
                                    <th>è¡¨ç¤ºé †åº</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="deviceManagementList">
                                <tr>
                                    <td colspan="6" class="text-center">èª­ã¿è¾¼ã¿ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="deviceFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceFormTitle">ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="deviceForm">
                        <input type="hidden" id="deviceFormMode" value="add">
                        <input type="hidden" id="deviceFormOriginalAddr" value="">

                        <div class="mb-3">
                            <label for="deviceAddr" class="form-label">MACã‚¢ãƒ‰ãƒ¬ã‚¹ <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="deviceAddr" placeholder="ä¾‹: ECDA3BBE61E8"
                                required maxlength="12">
                            <small class="text-muted">12æ¡ã®16é€²æ•°ï¼ˆã‚³ãƒ­ãƒ³ã‚„ãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰</small>
                        </div>

                        <div class="mb-3">
                            <label for="deviceName" class="form-label">è¨­å‚™å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="deviceName" placeholder="ä¾‹: è¨­å‚™1å·æ©Ÿ" required>
                        </div>

                        <div class="mb-3">
                            <label for="deviceLocation" class="form-label">è¨­ç½®å ´æ‰€</label>
                            <input type="text" class="form-control" id="deviceLocation" placeholder="ä¾‹: è£½é€ ãƒ©ã‚¤ãƒ³ A">
                        </div>

                        <div class="mb-3">
                            <label for="deviceDescription" class="form-label">èª¬æ˜</label>
                            <input type="text" class="form-control" id="deviceDescription" placeholder="ä¾‹: ãƒ¡ã‚¤ãƒ³ç”Ÿç”£æ©Ÿ">
                        </div>

                        <div class="mb-3">
                            <label for="deviceIndex" class="form-label">è¡¨ç¤ºé †åº</label>
                            <input type="number" class="form-control" id="deviceIndex" value="999" min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary-modern" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="button" class="btn-modern" onclick="saveDevice()">
                        <i class="bi bi-check-circle"></i> ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¨¼åƒç‡è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="operationRateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="operationRateTitle">ç¨¼åƒç‡è¡¨ç¤º</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="operationRateDeviceAddr" value="">

                    <!-- æœŸé–“æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div class="row mb-3">
                        <div class="col-md-5">
                            <label class="form-label">é–‹å§‹æ—¥</label>
                            <input type="date" class="form-control" id="modalOperationStartDate">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">çµ‚äº†æ—¥</label>
                            <input type="date" class="form-control" id="modalOperationEndDate">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn-modern w-100" onclick="calculateOperationRate()">
                                <i class="bi bi-calculator"></i> è¨ˆç®—
                            </button>
                        </div>
                    </div>

                    <!-- çµæœè¡¨ç¤º -->
                    <div id="operationRateResult" style="display: none;">
                        <hr style="border-color: var(--border-color);">
                        <h4 class="text-center mb-4">
                            <span class="text-secondary">ç¨¼åƒç‡:</span> <span id="operationRateValue" class="text-cyan"
                                style="font-size: 2.5rem; font-weight: 700;">0%</span>
                        </h4>

                        <!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
                        <div class="operation-rate-table-container">
                            <table class="table table-sm operation-rate-table">
                                <thead>
                                    <tr>
                                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                        <th>æ™‚é–“ï¼ˆåˆ†ï¼‰</th>
                                        <th>å‰²åˆ</th>
                                    </tr>
                                </thead>
                                <tbody id="operationRateTable">
                                </tbody>
                            </table>
                        </div>

                        <!-- å††ã‚°ãƒ©ãƒ• -->
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="operationRatePieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="dataLogsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataLogsTitle">ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <span class="text-secondary">æœ€æ–° <strong class="text-cyan" id="logCount">0</strong>
                            ä»¶ã®ãƒ‡ãƒ¼ã‚¿å—ä¿¡å±¥æ­´</span>
                        <button class="btn-modern btn-sm" onclick="refreshDataLogs()">
                            <i class="bi bi-arrow-clockwise"></i> æ›´æ–°
                        </button>
                    </div>

                    <!-- ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="log-table-container">
                        <table class="table table-sm log-table">
                            <thead class="sticky-top">
                                <tr>
                                    <th>å—ä¿¡æ—¥æ™‚</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                </tr>
                            </thead>
                            <tbody id="dataLogsTableBody">
                                <tr>
                                    <td colspan="2" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™‚é–“å¸¯åˆ¥GreenAppleåç©«é‡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="hourlyGreenAppleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hourlyGreenAppleTitle">æ™‚é–“å¸¯åˆ¥GREEN APPLEåç©«é‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="hourlyGreenAppleContainer" class="hourly-apple-grid">
                        <!-- æ™‚é–“å¸¯åˆ¥ãƒªãƒ³ã‚´ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å‚™ã”ã¨ã®æ™‚é–“å¸¯åˆ¥ç¨¼åƒç‡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="deviceHourlyOperationModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceHourlyOperationTitle">æ™‚é–“å¸¯åˆ¥ç¨¼åƒç‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- æ—¥ä»˜é¸æŠ -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">æ—¥ä»˜ã‚’é¸æŠ</label>
                            <input type="date" class="form-control" id="deviceHourlyDatePicker">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn-modern w-100" onclick="loadDeviceHourlyData()">
                                <i class="bi bi-search"></i> è¡¨ç¤º
                            </button>
                        </div>
                    </div>

                    <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="deviceHourlyOperationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // WebSocketæ¥ç¶š
        let ws;
        let devices = {};
        let overallStatusChart, hourlyStatusChart, dailyOperationChart, dailyGreenAppleChart;
        let currentColumns = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3åˆ—

        // åˆ—æ•°è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadColumnSetting() {
            const saved = localStorage.getItem('deviceColumns');
            if (saved) {
                currentColumns = parseInt(saved);
                setColumns(currentColumns, false);
            }
        }

        // åˆ—æ•°ã‚’è¨­å®š
        function setColumns(columns, save = true) {
            currentColumns = columns;

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.column-selector .btn-icon').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`col-${columns}`).classList.add('active');

            // åˆ—æ•°ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
            let colClass = '';
            let isCompact = false;
            switch (columns) {
                case 2:
                    colClass = 'col-lg-6 col-md-6';
                    break;
                case 3:
                    colClass = 'col-lg-4 col-md-6';
                    break;
                case 4:
                    colClass = 'col-lg-3 col-md-6';
                    break;
                case 5:
                    colClass = 'col-lg-2-4 col-md-6';
                    isCompact = true;
                    break;
            }

            // ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ã®åˆ—ã‚¯ãƒ©ã‚¹ã¨ç°¡æ˜“è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
            document.querySelectorAll('#deviceList > div').forEach(card => {
                card.className = colClass;
                const deviceCard = card.querySelector('.device-card');
                if (deviceCard) {
                    if (isCompact) {
                        deviceCard.classList.add('compact-view');
                    } else {
                        deviceCard.classList.remove('compact-view');
                    }
                }
            });

            // è¨­å®šã‚’ä¿å­˜
            if (save) {
                localStorage.setItem('deviceColumns', columns);
            }
        }

        // å…¨ç”»é¢è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.getElementById('fullscreenIcon').className = 'bi bi-fullscreen-exit';
                }).catch(err => {
                    console.error('å…¨ç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen().then(() => {
                        document.getElementById('fullscreenIcon').className = 'bi bi-arrows-fullscreen';
                    });
                }
            }
        }

        // å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                document.getElementById('fullscreenIcon').className = 'bi bi-fullscreen-exit';
            } else {
                document.getElementById('fullscreenIcon').className = 'bi bi-arrows-fullscreen';
            }
        });

        // ç¾åœ¨æ™‚åˆ»ã®æ›´æ–°
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('ja-JP');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // WebSocketæ¥ç¶š
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('WebSocketæ¥ç¶šæˆåŠŸ');
                const badge = document.getElementById('connectionBadge');
                badge.innerHTML = '<i class="bi bi-wifi"></i> æ¥ç¶šä¸­';
                badge.parentElement.className = 'connection-status-badge connected';

                // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                fetchDevices();

                // ç¾åœ¨ã®ç¨¼åƒç‡ã‚’å®šæœŸçš„ã«æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ï¼‰
                setInterval(() => {
                    Object.keys(devices).forEach(deviceAddr => {
                        loadCurrentOperationRate(deviceAddr);
                    });
                }, 60000); // 60ç§’ = 1åˆ†
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'device_update') {
                    updateDevice(data);
                }
            };

            ws.onclose = () => {
                console.log('WebSocketåˆ‡æ–­');
                const badge = document.getElementById('connectionBadge');
                badge.innerHTML = '<i class="bi bi-wifi-off"></i> åˆ‡æ–­';
                badge.parentElement.className = 'connection-status-badge disconnected';

                // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’è¡¨ç¤º
                showErrorNotification('ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¦ã„ã¾ã™...');

                // 5ç§’å¾Œã«å†æ¥ç¶š
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
            };

            // Pingé€ä¿¡ï¼ˆæ¥ç¶šç¶­æŒï¼‰
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send('ping');
                }
            }, 30000);
        }

        // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å–å¾—
        async function fetchDevices() {
            try {
                const response = await fetch('/api/devices');
                const deviceList = await response.json();

                // device_addrã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
                deviceList.forEach(device => {
                    devices[device.device_addr] = device;
                });

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                const loadingMsg = document.getElementById('loadingMessage');
                if (loadingMsg) loadingMsg.style.display = 'none';

                renderDevices();
                updateStatistics();
            } catch (error) {
                console.error('ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’æ›´æ–°
        function updateDevice(data) {
            // device_addrã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼ˆMACã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
            const key = data.device_addr || data.device_id;

            // æ—¢å­˜ã®ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ä¿æŒã—ã¤ã¤æ›´æ–°
            if (devices[key]) {
                // æ—¢å­˜ã®ãƒ‡ãƒã‚¤ã‚¹åãªã©ã‚’ä¿æŒ
                devices[key] = {
                    ...devices[key],
                    device_id: data.device_id,
                    device_addr: data.device_addr,
                    device_name: data.device_name || devices[key].device_name,
                    location: data.location || devices[key].location,
                    description: data.description || devices[key].description,
                    index: data.index !== undefined ? data.index : devices[key].index,
                    gateway_id: data.gateway_id,
                    battery: data.battery,
                    red: data.red,
                    yellow: data.yellow,
                    green: data.green,
                    status_code: data.status_code,
                    status_text: data.status_text,
                    last_update: data.timestamp,
                    is_active: true
                };
            } else {
                // æ–°è¦ãƒ‡ãƒã‚¤ã‚¹
                devices[key] = {
                    device_id: data.device_id,
                    device_addr: data.device_addr,
                    device_name: data.device_name || data.device_addr,
                    location: data.location || '',
                    description: data.description || '',
                    index: data.index !== undefined ? data.index : 999,
                    gateway_id: data.gateway_id,
                    battery: data.battery,
                    red: data.red,
                    yellow: data.yellow,
                    green: data.green,
                    status_code: data.status_code,
                    status_text: data.status_text,
                    last_update: data.timestamp,
                    is_active: true
                };
            }

            renderDevices();
            updateStatistics();
            updateOverallCharts();  // å…¨ä½“ç¨¼åƒç‡ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        }

        // ãƒ‡ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’æç”»
        function renderDevices() {
            const container = document.getElementById('deviceList');
            container.innerHTML = '';

            Object.values(devices).forEach(device => {
                const card = createDeviceCard(device);
                container.appendChild(card);

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¨ç¾åœ¨ã®ç¨¼åƒç‡ã‚’èª­ã¿è¾¼ã¿
                if (device.device_addr) {
                    loadDeviceTimeline(device.device_addr);
                    loadCurrentOperationRate(device.device_addr);
                }
            });
        }

        // ãƒ‡ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createDeviceCard(device) {
            const col = document.createElement('div');

            // åˆ—æ•°è¨­å®šã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
            switch (currentColumns) {
                case 2:
                    col.className = 'col-lg-6 col-md-6';
                    break;
                case 3:
                    col.className = 'col-lg-4 col-md-6';
                    break;
                case 4:
                    col.className = 'col-lg-3 col-md-6';
                    break;
                case 5:
                    col.className = 'col-lg-2-4 col-md-6';
                    break;
                default:
                    col.className = 'col-lg-4 col-md-6';
            }

            const status = device.status_text || getDeviceStatus(device);
            // ãƒ©ã‚¤ãƒˆã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒãƒƒã‚¸ã®è‰²ã¨ã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š
            const statusBadgeClass = getStatusBadgeClass(device);
            const isOffline = !device.is_active;
            const isRunning = device.green; // ç·‘ãƒ©ã‚¤ãƒˆãŒç‚¹ç¯ã—ã¦ã„ã‚‹ = ç¨¼åƒä¸­

            // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’JSTï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«å¤‰æ›
            let lastUpdate = 'æœªå—ä¿¡';
            if (device.last_update) {
                const utcDate = new Date(device.last_update + 'Z'); // Zã‚’ä»˜ã‘ã¦UTCã¨ã—ã¦è§£é‡ˆ
                lastUpdate = utcDate.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
            }

            const deviceName = device.device_name || device.device_addr || `#${device.device_id}`;
            const location = device.location || '';
            const description = device.description || '';

            // ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š
            let cardClasses = 'device-card';
            if (isOffline) cardClasses += ' offline';
            if (isRunning && !isOffline) cardClasses += ' running';
            if (currentColumns === 5) cardClasses += ' compact-view';

            col.innerHTML = `
                <div class="${cardClasses}">
                    <div class="device-header">
                        <div>
                            <div class="device-name">${deviceName}</div>
                            <div class="device-location">
                                <i class="bi bi-geo-alt"></i> ${location || 'æœªè¨­å®š'}
                            </div>
                        </div>
                        <div>
                            <span class="device-status-badge ${statusBadgeClass}">${status}</span>
                        </div>
                    </div>

                    ${description ? `<p class="text-secondary" style="font-size: 0.85rem; margin-bottom: 1rem;">${description}</p>` : ''}

                    <!-- ãƒ©ã‚¤ãƒˆã‚¿ãƒ¯ãƒ¼è¡¨ç¤º -->
                    <div class="lights-container">
                        <div class="light-indicator ${device.green ? 'active green' : 'inactive'}">
                            <i class="bi bi-circle-fill"></i>
                        </div>
                        <div class="light-indicator ${device.yellow ? 'active yellow' : 'inactive'}">
                            <i class="bi bi-circle-fill"></i>
                        </div>
                        <div class="light-indicator ${device.red ? 'active red' : 'inactive'}">
                            <i class="bi bi-circle-fill"></i>
                        </div>
                    </div>

                    <!-- ãƒãƒƒãƒ†ãƒªãƒ¼è¡¨ç¤º -->
                    <div class="battery-container mb-3">
                        <div class="battery-icon ${getBatteryTextClass(device.battery)}">
                            <i class="bi bi-battery-charging"></i>
                        </div>
                        <div class="battery-text ${getBatteryTextClass(device.battery)}">
                            ${device.battery}%
                        </div>
                    </div>

                    <!-- ç¾åœ¨ã®ç¨¼åƒç‡è¡¨ç¤º -->
                    <div class="operation-rate-container" id="current-rate-${device.device_addr}">
                        <div class="operation-rate-title">æœ¬æ—¥ç¨¼åƒç‡ (6:00ï½ç¾åœ¨)</div>
                        <div class="d-flex align-items-baseline justify-content-between">
                            <div class="operation-rate-value" id="rate-value-${device.device_addr}">--%</div>
                            <div class="operation-rate-detail" id="rate-detail-${device.device_addr}">èª­è¾¼ä¸­...</div>
                        </div>
                    </div>

                    <!-- ç¨¼åƒçŠ¶æ³ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
                    <div class="timeline-container" id="timeline-${device.device_addr}">
                        <div class="timeline-label">æ—¥å‹¤ (6:00-18:00)</div>
                        <div class="timeline-bar" id="timeline-day-${device.device_addr}">
                            <div class="timeline-segment gray" style="flex: 1;"></div>
                        </div>
                        <div class="timeline-label">å¤œå‹¤ (18:00-ç¿Œ6:00)</div>
                        <div class="timeline-bar" id="timeline-night-${device.device_addr}">
                            <div class="timeline-segment gray" style="flex: 1;"></div>
                        </div>
                    </div>

                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <button class="btn-modern flex-grow-1" onclick="showOperationRate('${device.device_addr}', '${deviceName}')">
                            <i class="bi bi-graph-up"></i> ç¨¼åƒç‡
                        </button>
                        <button class="btn-modern flex-grow-1" onclick="showDeviceHourlyOperation('${device.device_addr}', '${deviceName}')">
                            <i class="bi bi-bar-chart"></i> æ™‚é–“å¸¯åˆ¥
                        </button>
                        <button class="btn-secondary-modern flex-grow-1" onclick="showDataLogs('${device.device_addr}', '${deviceName}')">
                            <i class="bi bi-list-ul"></i> ãƒ­ã‚°
                        </button>
                    </div>

                    <div class="mt-3 pt-3 device-meta-info" style="border-top: 1px solid var(--border-color);">
                        <div class="device-meta-item">
                            <i class="bi bi-clock-history"></i>
                            <span class="device-meta-label">æœ€çµ‚æ›´æ–°:</span>
                            <span class="device-meta-value">${lastUpdate}</span>
                        </div>
                        <div class="device-meta-item">
                            <i class="bi bi-hdd-network"></i>
                            <span class="device-meta-label">MAC:</span>
                            <span class="device-meta-value">${device.device_addr}</span>
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚¯ãƒ©ã‚¹ã®æ±ºå®š
        function getStatusBadgeClass(device) {
            if (device.green) return 'status-running';  // ç·‘ãƒ©ã‚¤ãƒˆ = ç¨¼åƒä¸­
            if (device.yellow) return 'status-warning'; // é»„ãƒ©ã‚¤ãƒˆ = åœæ­¢ä¸­(é»„)
            if (device.red) return 'status-stop'; // èµ¤ãƒ©ã‚¤ãƒˆ = åœæ­¢ä¸­(èµ¤)
            return 'status-idle'; // å…¨æ¶ˆç¯ = ä¼‘æ­¢ä¸­
        }

        // ãƒ‡ãƒã‚¤ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ¤å®š
        function getDeviceStatus(device) {
            // status_textãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
            if (device.status_text) {
                return device.status_text;
            }
            // ãªã‘ã‚Œã°ãƒ©ã‚¤ãƒˆçŠ¶æ…‹ã‹ã‚‰åˆ¤å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
            if (device.green) return 'Running';
            if (device.yellow) return 'Stop';
            if (device.red) return 'Stop';
            return 'Not Working';
        }

        // ãƒ©ã‚¤ãƒˆã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒãƒƒã‚¸ã®è‰²ã‚’å–å¾—
        function getStatusColorByLight(device) {
            // ãƒ©ã‚¤ãƒˆã®çŠ¶æ…‹ã§åˆ¤å®šï¼ˆç·‘â†’é»„â†’èµ¤ã®å„ªå…ˆé †ä½ï¼‰
            if (device.green) return 'bg-success';  // ç·‘ãƒ©ã‚¤ãƒˆ = ç¨¼åƒä¸­
            if (device.yellow) return 'bg-warning'; // é»„ãƒ©ã‚¤ãƒˆ = åœæ­¢ä¸­(é»„)
            if (device.red) return 'bg-danger';     // èµ¤ãƒ©ã‚¤ãƒˆ = åœæ­¢ä¸­(èµ¤)
            return 'bg-secondary';                   // å…¨æ¶ˆç¯ = Not Working
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã‚’å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function getStatusColor(status) {
            const colors = {
                'Running': 'bg-success',
                'ç¨¼åƒä¸­': 'bg-success',
                'Stop': 'bg-danger',
                'åœæ­¢ä¸­': 'bg-danger',
                'Not Working': 'bg-secondary',
                'åœæ­¢': 'bg-secondary'
            };
            return colors[status] || 'bg-secondary';
        }

        // ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡ã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        function getBatteryTextClass(battery) {
            if (battery > 50) return 'battery-high';
            if (battery > 20) return 'battery-medium';
            return 'battery-low';
        }

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStatistics() {
            const deviceArray = Object.values(devices);

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒã‚¤ã‚¹ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
            const activeDevices = deviceArray.filter(d => d.is_active);

            document.getElementById('deviceCount').textContent = activeDevices.length + ' / 7';

            // ãƒ©ã‚¤ãƒˆçŠ¶æ…‹ã‹ã‚‰åˆ¤å®šï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
            const runningCount = activeDevices.filter(d => d.green).length;  // ç·‘ãƒ©ã‚¤ãƒˆ = ç¨¼åƒä¸­
            const warningCount = activeDevices.filter(d => d.yellow).length; // é»„ãƒ©ã‚¤ãƒˆ = åœæ­¢ä¸­(é»„)
            const errorCount = activeDevices.filter(d => d.red).length;      // èµ¤ãƒ©ã‚¤ãƒˆ = åœæ­¢ä¸­(èµ¤)
            const noneCount = activeDevices.filter(d => !d.green && !d.yellow && !d.red).length; // å…¨æ¶ˆç¯ = ä¼‘æ­¢ä¸­

            document.getElementById('runningCount').textContent = runningCount;
            document.getElementById('warningCount').textContent = warningCount;
            document.getElementById('errorCount').textContent = errorCount;
            document.getElementById('noneCount').textContent = noneCount;
        }

        // ã‚°ãƒ©ãƒ•åˆæœŸåŒ–
        function initCharts() {
            // å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å††ã‚°ãƒ©ãƒ•
            const overallStatusCtx = document.getElementById('overallStatusChart').getContext('2d');
            overallStatusChart = new Chart(overallStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ç¨¼åƒä¸­', 'STOP(é»„)', 'STOP(èµ¤)', 'ä¼‘æ­¢ä¸­'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(0, 255, 136, 0.7)',
                            'rgba(255, 214, 10, 0.7)',
                            'rgba(255, 0, 84, 0.7)',
                            'rgba(108, 117, 125, 0.5)'
                        ],
                        borderColor: [
                            '#00ff88',
                            '#ffd60a',
                            '#ff0054',
                            '#6c757d'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#b0b8c9',
                                font: {
                                    size: 14
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed + '%';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // æ™‚é–“å¸¯åˆ¥ç©ä¸Šã’æ£’ã‚°ãƒ©ãƒ•
            // 24æ™‚é–“åˆ†ã®ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆ6:00ï½ç¿Œ5:00ï¼‰
            const hourlyLabels = [];
            for (let i = 0; i < 24; i++) {
                const hour = (6 + i) % 24;
                hourlyLabels.push(`${hour.toString().padStart(2, '0')}:00`);
            }

            const hourlyStatusCtx = document.getElementById('hourlyStatusChart').getContext('2d');
            hourlyStatusChart = new Chart(hourlyStatusCtx, {
                type: 'bar',
                data: {
                    labels: hourlyLabels,
                    datasets: [
                        {
                            label: 'ç¨¼åƒä¸­',
                            data: Array(24).fill(0),
                            backgroundColor: 'rgba(0, 255, 136, 0.7)',
                            borderColor: '#00ff88',
                            borderWidth: 1
                        },
                        {
                            label: 'STOP(é»„)',
                            data: Array(24).fill(0),
                            backgroundColor: 'rgba(255, 214, 10, 0.7)',
                            borderColor: '#ffd60a',
                            borderWidth: 1
                        },
                        {
                            label: 'STOP(èµ¤)',
                            data: Array(24).fill(0),
                            backgroundColor: 'rgba(255, 0, 84, 0.7)',
                            borderColor: '#ff0054',
                            borderWidth: 1
                        },
                        {
                            label: 'ä¼‘æ­¢ä¸­',
                            data: Array(24).fill(0),
                            backgroundColor: 'rgba(108, 117, 125, 0.5)',
                            borderColor: '#6c757d',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#b0b8c9'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y + '%';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                color: 'rgba(0, 217, 255, 0.1)'
                            },
                            ticks: {
                                color: '#b0b8c9'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 217, 255, 0.1)'
                            },
                            ticks: {
                                color: '#b0b8c9',
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // æ—¥æ¬¡ç¨¼åƒç‡æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
            const dailyOperationCtx = document.getElementById('dailyOperationChart').getContext('2d');
            dailyOperationChart = new Chart(dailyOperationCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å…¨ä½“ç¨¼åƒç‡ (%)',
                        data: [],
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#00d9ff',
                        pointBorderColor: '#00d9ff',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#b0b8c9',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 217, 255, 0.1)'
                            },
                            ticks: {
                                color: '#b0b8c9'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 217, 255, 0.1)'
                            },
                            ticks: {
                                color: '#b0b8c9',
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // æ—¥æ¬¡GreenAppleåç©«é‡æ£’ã‚°ãƒ©ãƒ•
            const dailyGreenAppleCtx = document.getElementById('dailyGreenAppleChart').getContext('2d');
            dailyGreenAppleChart = new Chart(dailyGreenAppleCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'GREEN APPLEåç©«é‡ (å€‹)',
                        data: [],
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 2,
                        borderRadius: 8,
                        hoverBackgroundColor: 'rgba(0, 255, 136, 0.9)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#b0b8c9',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'ğŸ ' + context.parsed.y + 'å€‹';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 217, 255, 0.1)'
                            },
                            ticks: {
                                color: '#b0b8c9'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 217, 255, 0.1)'
                            },
                            ticks: {
                                color: '#b0b8c9',
                                stepSize: 1,
                                callback: function (value) {
                                    return value + 'å€‹';
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const clickedData = dailyGreenAppleChart.data.datasets[0].data;
                            const fullDate = dailyGreenAppleChartData[index]; // å®Œå…¨ãªæ—¥ä»˜ã‚’ä¿æŒ
                            showHourlyGreenApples(fullDate);
                        }
                    }
                }
            });
        }

        // æ—¥åˆ¥GreenAppleãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ—¥ä»˜ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let dailyGreenAppleChartData = [];

        // æ™‚é–“å¸¯åˆ¥GreenAppleåç©«é‡ã‚’è¡¨ç¤º
        async function showHourlyGreenApples(dateStr) {
            const modal = new bootstrap.Modal(document.getElementById('hourlyGreenAppleModal'));
            document.getElementById('hourlyGreenAppleTitle').textContent = `æ™‚é–“å¸¯åˆ¥GREEN APPLEåç©«é‡ - ${dateStr}`;
            modal.show();

            const container = document.getElementById('hourlyGreenAppleContainer');
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-cyan" role="status"></div></div>';

            try {
                const response = await fetch(`/api/overall/hourly-green-apples?date=${dateStr}`);
                const data = await response.json();

                // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
                container.innerHTML = '';

                // å„æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                data.data.forEach(hourData => {
                    const item = document.createElement('div');
                    item.className = 'hourly-apple-item';
                    if (hourData.apples > 0) {
                        item.classList.add('has-apples');
                    }

                    // æ™‚é–“å¸¯ãƒ˜ãƒƒãƒ€ãƒ¼
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'hourly-apple-time';
                    timeDiv.innerHTML = `<i class="bi bi-clock"></i> ${hourData.hour}`;

                    // ç¨¼åƒç‡
                    const rateDiv = document.createElement('div');
                    rateDiv.className = 'hourly-apple-rate';
                    rateDiv.textContent = `ç¨¼åƒç‡: ${hourData.running_percent}%`;

                    // ãƒªãƒ³ã‚´è¡¨ç¤º
                    const appleDisplay = document.createElement('div');
                    appleDisplay.className = 'hourly-apple-display';

                    if (hourData.apples === 0) {
                        const noApples = document.createElement('span');
                        noApples.className = 'no-apples-text';
                        noApples.textContent = 'åç©«ãªã—';
                        appleDisplay.appendChild(noApples);
                    } else {
                        for (let i = 0; i < hourData.apples; i++) {
                            const apple = document.createElement('span');
                            apple.className = 'hourly-apple-icon';
                            apple.textContent = 'ğŸ';
                            apple.title = `GREEN APPLE ${i + 1}å€‹ç›®`;
                            appleDisplay.appendChild(apple);
                        }
                    }

                    item.appendChild(timeDiv);
                    item.appendChild(rateDiv);
                    item.appendChild(appleDisplay);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('æ™‚é–“å¸¯åˆ¥GREEN APPLEå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<div class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // GreenAppleè¡¨ç¤ºã‚’æ›´æ–°
        function updateGreenAppleDisplay(count) {
            const display = document.getElementById('GreenAppleDisplay');
            if (!display) return;

            // ãƒªãƒ³ã‚´ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç”Ÿæˆ
            display.innerHTML = '';

            if (count === 0) {
                display.innerHTML = '<span style="color: var(--text-muted); font-size: 0.8rem;">0å€‹</span>';
            } else {
                for (let i = 0; i < count; i++) {
                    const apple = document.createElement('span');
                    apple.className = 'green-apple';
                    apple.textContent = 'ğŸ';
                    apple.title = `GREEN APPLE ${i + 1}å€‹ç›®`;
                    display.appendChild(apple);
                }
            }
        }

        // å…¨ä½“ç¨¼åƒç‡ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        async function updateOverallCharts() {
            try {
                // ç¾åœ¨ã®å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
                const statusResponse = await fetch('/api/overall/current-status');

                if (!statusResponse.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${statusResponse.status}`);
                }

                const statusData = await statusResponse.json();

                if (overallStatusChart) {
                    overallStatusChart.data.datasets[0].data = [
                        statusData.running,
                        statusData.stop_yellow,
                        statusData.stop_red,
                        statusData.idle
                    ];
                    overallStatusChart.update();
                }

                // æ™‚é–“å¸¯åˆ¥ç¨¼åƒæ¨ç§»ç”¨ã®æ—¥ä»˜ã‚’æ±ºå®šï¼ˆ6:00ã‚ˆã‚Šå‰ãªã‚‰å‰æ—¥ï¼‰
                const now = new Date();
                const currentHour = now.getHours();
                const targetDate = new Date(now);
                if (currentHour < 6) {
                    targetDate.setDate(targetDate.getDate() - 1);
                }
                const dateStr = formatDateLocal(targetDate);

                // æ™‚é–“å¸¯åˆ¥ç¨¼åƒæ¨ç§»ï¼ˆç©ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼‰
                const hourlyResponse = await fetch(`/api/overall/hourly-status?date=${dateStr}`);

                if (!hourlyResponse.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${hourlyResponse.status}`);
                }

                const hourlyData = await hourlyResponse.json();

                if (hourlyStatusChart && hourlyData.data) {
                    // 24æ™‚é–“åˆ†ã®ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆ6:00ï½ç¿Œ5:00ï¼‰
                    const allHours = [];
                    for (let i = 0; i < 24; i++) {
                        const hour = (6 + i) % 24;
                        allHours.push(`${hour.toString().padStart(2, '0')}:00`);
                    }

                    // APIãƒ‡ãƒ¼ã‚¿ã‚’æ™‚é–“å¸¯ã”ã¨ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                    const dataMap = {};
                    hourlyData.data.forEach(d => {
                        dataMap[d.hour] = d;
                    });

                    // 24æ™‚é–“åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„æ™‚é–“ã¯0ï¼‰
                    const runningData = allHours.map(h => dataMap[h]?.running || 0);
                    const stopYellowData = allHours.map(h => dataMap[h]?.stop_yellow || 0);
                    const stopRedData = allHours.map(h => dataMap[h]?.stop_red || 0);
                    const idleData = allHours.map(h => dataMap[h]?.idle || 0);

                    hourlyStatusChart.data.labels = allHours;
                    hourlyStatusChart.data.datasets[0].data = runningData;
                    hourlyStatusChart.data.datasets[1].data = stopYellowData;
                    hourlyStatusChart.data.datasets[2].data = stopRedData;
                    hourlyStatusChart.data.datasets[3].data = idleData;
                    hourlyStatusChart.update();

                    // GreenAppleç²å¾—æ•°ã‚’æ›´æ–°
                    updateGreenAppleDisplay(hourlyData.total_green_apples || 0);
                }

                // æœˆæ¬¡ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ï¼ˆåˆ¥é–¢æ•°ã§å‡¦ç†ï¼‰
                updateMonthlyCharts();

                // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆæˆåŠŸæ™‚ï¼‰
                clearErrorNotification();
            } catch (error) {
                console.error('å…¨ä½“ç¨¼åƒç‡ã‚°ãƒ©ãƒ•ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showErrorNotification('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’è¡¨ç¤º
        function showErrorNotification(message) {
            // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
            clearErrorNotification();

            const notification = document.createElement('div');
            notification.id = 'error-notification';
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background-color: rgba(220, 53, 69, 0.95);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 400px;
            `;

            notification.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill" style="font-size: 1.2rem;"></i>
                <span>${message}</span>
                <button onclick="location.reload()" style="
                    background: white;
                    color: #dc3545;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    margin-left: 10px;
                ">å†èª­ã¿è¾¼ã¿</button>
                <button onclick="clearErrorNotification()" style="
                    background: transparent;
                    color: white;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    padding: 0;
                    margin-left: 5px;
                ">Ã—</button>
            `;

            document.body.appendChild(notification);
        }

        // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’ã‚¯ãƒªã‚¢
        function clearErrorNotification() {
            const notification = document.getElementById('error-notification');
            if (notification) {
                notification.remove();
            }
        }

        // æœˆæ¬¡ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ï¼ˆç¨¼åƒç‡æ¨ç§»ã¨GreenAppleåç©«é‡ï¼‰
        async function updateMonthlyCharts() {
            try {
                // ç¨¼åƒç‡æ¨ç§»ã‚°ãƒ©ãƒ•ã®æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
                const operationStartDate = document.getElementById('operationStartDate').value;
                const operationEndDate = document.getElementById('operationEndDate').value;

                // GreenAppleåç©«é‡ã‚°ãƒ©ãƒ•ã®æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
                const appleStartDate = document.getElementById('appleStartDate').value;
                const appleEndDate = document.getElementById('appleEndDate').value;

                // ç¨¼åƒç‡æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰
                if (operationStartDate && operationEndDate) {
                    const dailyResponse = await fetch(`/api/overall/daily-operation-rate?start_date=${operationStartDate}&end_date=${operationEndDate}`);
                    const dailyData = await dailyResponse.json();

                    if (dailyOperationChart && dailyData.data) {
                        dailyOperationChart.data.labels = dailyData.data.map(d => d.date);
                        dailyOperationChart.data.datasets[0].data = dailyData.data.map(d => d.rate);
                        dailyOperationChart.update();
                    }
                }

                // GreenAppleåç©«é‡ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
                if (appleStartDate && appleEndDate) {
                    const dailyApplesResponse = await fetch(`/api/overall/daily-green-apples?start_date=${appleStartDate}&end_date=${appleEndDate}`);
                    const dailyApplesData = await dailyApplesResponse.json();

                    if (dailyGreenAppleChart && dailyApplesData.data) {
                        // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                        dailyGreenAppleChart.data.labels = dailyApplesData.data.map(d => d.date);
                        dailyGreenAppleChart.data.datasets[0].data = dailyApplesData.data.map(d => d.apples);
                        dailyGreenAppleChart.update();

                        // å®Œå…¨ãªæ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚ã«ä½¿ç”¨ï¼‰
                        dailyGreenAppleChartData = dailyApplesData.data.map(d => d.full_date);
                    }
                }
            } catch (error) {
                console.error('æœˆæ¬¡ã‚°ãƒ©ãƒ•ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆæœŸåŒ–
        function initializeDateSelectors() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            // ä»Šæœˆã®1æ—¥ã‚’å–å¾—
            const firstDay = new Date(currentYear, currentMonth, 1);
            const firstDayStr = formatDateLocal(firstDay);

            // ä»Šæœˆã®æœ«æ—¥ã‚’å–å¾—ï¼ˆç¿Œæœˆã®0æ—¥ = ä»Šæœˆã®æœ«æ—¥ï¼‰
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const lastDayStr = formatDateLocal(lastDay);

            // ç¨¼åƒç‡æ¨ç§»ã®æ—¥ä»˜ç¯„å›²ã‚’è¨­å®šï¼ˆä»Šæœˆã®1æ—¥ï½æœ«æ—¥ï¼‰
            document.getElementById('operationStartDate').value = firstDayStr;
            document.getElementById('operationEndDate').value = lastDayStr;

            // GreenAppleåç©«é‡ã®æ—¥ä»˜ç¯„å›²ã‚’è¨­å®šï¼ˆä»Šæœˆã®1æ—¥ï½æœ«æ—¥ï¼‰
            document.getElementById('appleStartDate').value = firstDayStr;
            document.getElementById('appleEndDate').value = lastDayStr;
        }

        // èµ·å‹•æ™‚ã®å‡¦ç†
        window.addEventListener('load', () => {
            loadColumnSetting();  // åˆ—æ•°è¨­å®šã‚’èª­ã¿è¾¼ã¿
            initializeDateSelectors();  // å¹´æœˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
            connectWebSocket();
            initCharts();
            updateOverallCharts();  // å…¨ä½“ç¨¼åƒç‡ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–

            // å…¨ä½“ç¨¼åƒç‡ã‚°ãƒ©ãƒ•ã‚’1åˆ†ã”ã¨ã«æ›´æ–°
            setInterval(updateOverallCharts, 60000);
        });

        // ========== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ ==========

        // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã¿
        async function loadDeviceTimeline(deviceAddr) {
            try {
                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”¨ã®æ—¥ä»˜ã‚’æ±ºå®šï¼ˆ6:00ã‚ˆã‚Šå‰ãªã‚‰å‰æ—¥ï¼‰
                const now = new Date();
                const currentHour = now.getHours();
                const targetDate = new Date(now);
                if (currentHour < 6) {
                    targetDate.setDate(targetDate.getDate() - 1);
                }
                const dateStr = formatDateLocal(targetDate);

                const response = await fetch(`/api/devices/${deviceAddr}/timeline?date=${dateStr}`);
                if (!response.ok) {
                    console.error(`ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼: ${deviceAddr}`);
                    return;
                }

                const data = await response.json();

                // æ—¥å‹¤ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æç”»
                const dayBarId = `timeline-day-${deviceAddr}`;
                renderTimeline(dayBarId, data.day_shift.segments);

                // å¤œå‹¤ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æç”»
                const nightBarId = `timeline-night-${deviceAddr}`;
                renderTimeline(nightBarId, data.night_shift.segments);

            } catch (error) {
                console.error('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ã‚’æç”»
        function renderTimeline(elementId, segments) {
            const barElement = document.getElementById(elementId);
            if (!barElement) return;

            barElement.innerHTML = '';

            // ç·æ™‚é–“ã‚’è¨ˆç®—
            const totalMinutes = segments.reduce((sum, seg) => sum + seg.duration_minutes, 0);

            segments.forEach(segment => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = `timeline-segment ${segment.color}`;

                // å¹…ã‚’å‰²åˆã§è¨­å®š
                const widthPercent = (segment.duration_minutes / totalMinutes) * 100;
                segmentDiv.style.flex = `0 0 ${widthPercent}%`;

                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆã‚¿ã‚¤ãƒˆãƒ«å±æ€§ï¼‰
                const statusText = {
                    'running': 'ç¨¼åƒ',
                    'stop_yellow': 'åœæ­¢(é»„)',
                    'stop_red': 'åœæ­¢(èµ¤)',
                    'none': 'æœªç¨¼åƒ',
                    'future': 'æœªæ¥'
                }[segment.status] || segment.status;

                const startTime = new Date(segment.start).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                const endTime = new Date(segment.end).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                segmentDiv.title = `${statusText}: ${startTime} - ${endTime} (${segment.duration_minutes}åˆ†)`;

                barElement.appendChild(segmentDiv);
            });
        }

        // ========== ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†æ©Ÿèƒ½ ==========

        // ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDeviceManagement() {
            const modal = new bootstrap.Modal(document.getElementById('deviceManagementModal'));
            modal.show();
            loadDeviceManageList();
        }

        // ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadDeviceManageList() {
            try {
                const response = await fetch('/api/devices/config');
                const devices = await response.json();

                const tbody = document.getElementById('deviceManagementList');
                tbody.innerHTML = '';

                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }

                devices.forEach(device => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><code>${device.device_addr}</code></td>
                        <td>${device.name}</td>
                        <td>${device.location}</td>
                        <td>${device.description}</td>
                        <td>${device.index}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editDevice('${device.device_addr}')">
                                ç·¨é›†
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice('${device.device_addr}', '${device.name}')">
                                å‰Šé™¤
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        function showAddDeviceForm() {
            document.getElementById('deviceFormTitle').textContent = 'ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ ';
            document.getElementById('deviceFormMode').value = 'add';
            document.getElementById('deviceFormOriginalAddr').value = '';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('deviceAddr').value = '';
            document.getElementById('deviceAddr').disabled = false;
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceLocation').value = '';
            document.getElementById('deviceDescription').value = '';
            document.getElementById('deviceIndex').value = '999';

            const modal = new bootstrap.Modal(document.getElementById('deviceFormModal'));
            modal.show();
        }

        // ãƒ‡ãƒã‚¤ã‚¹ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        async function editDevice(deviceAddr) {
            try {
                const response = await fetch('/api/devices/config');
                const devices = await response.json();
                const device = devices.find(d => d.device_addr === deviceAddr);

                if (!device) {
                    alert('ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                document.getElementById('deviceFormTitle').textContent = 'ãƒ‡ãƒã‚¤ã‚¹ç·¨é›†';
                document.getElementById('deviceFormMode').value = 'edit';
                document.getElementById('deviceFormOriginalAddr').value = deviceAddr;

                document.getElementById('deviceAddr').value = device.device_addr;
                document.getElementById('deviceAddr').disabled = true; // ç·¨é›†æ™‚ã¯MACã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ä¸å¯
                document.getElementById('deviceName').value = device.name;
                document.getElementById('deviceLocation').value = device.location;
                document.getElementById('deviceDescription').value = device.description;
                document.getElementById('deviceIndex').value = device.index;

                const modal = new bootstrap.Modal(document.getElementById('deviceFormModal'));
                modal.show();
            } catch (error) {
                console.error('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹ã‚’ä¿å­˜ï¼ˆè¿½åŠ /ç·¨é›†å…±é€šï¼‰
        async function saveDevice() {
            const mode = document.getElementById('deviceFormMode').value;
            const deviceAddr = document.getElementById('deviceAddr').value.trim().toUpperCase();
            const name = document.getElementById('deviceName').value.trim();
            const location = document.getElementById('deviceLocation').value.trim();
            const description = document.getElementById('deviceDescription').value.trim();
            const index = parseInt(document.getElementById('deviceIndex').value);

            if (!deviceAddr || !name) {
                alert('MACã‚¢ãƒ‰ãƒ¬ã‚¹ã¨è¨­å‚™åã¯å¿…é ˆã§ã™');
                return;
            }

            // MACã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!/^[0-9A-F]{12}$/i.test(deviceAddr)) {
                alert('MACã‚¢ãƒ‰ãƒ¬ã‚¹ã¯12æ¡ã®16é€²æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ECDA3BBE61E8ï¼‰');
                return;
            }

            try {
                let response;
                if (mode === 'add') {
                    // æ–°è¦è¿½åŠ 
                    response = await fetch('/api/devices/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            device_addr: deviceAddr,
                            name: name,
                            location: location,
                            description: description,
                            index: index
                        })
                    });
                } else {
                    // ç·¨é›†
                    const originalAddr = document.getElementById('deviceFormOriginalAddr').value;
                    response = await fetch(`/api/devices/${originalAddr}?name=${encodeURIComponent(name)}&location=${encodeURIComponent(location)}&description=${encodeURIComponent(description)}&index=${index}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    const formModal = bootstrap.Modal.getInstance(document.getElementById('deviceFormModal'));
                    formModal.hide();

                    // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    loadDeviceManageList();

                    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚‚å†èª­ã¿è¾¼ã¿
                    fetchDevices();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${result.detail}`);
                }
            } catch (error) {
                console.error('ãƒ‡ãƒã‚¤ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒã‚¤ã‚¹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹ã‚’å‰Šé™¤
        async function deleteDevice(deviceAddr, deviceName) {
            if (!confirm(`ãƒ‡ãƒã‚¤ã‚¹ã€Œ${deviceName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nMACã‚¢ãƒ‰ãƒ¬ã‚¹: ${deviceAddr}`)) {
                return;
            }

            try {
                const response = await fetch(`/api/devices/${deviceAddr}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);

                    // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    loadDeviceManageList();

                    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚‚å†èª­ã¿è¾¼ã¿
                    fetchDevices();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${result.detail}`);
                }
            } catch (error) {
                console.error('ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒã‚¤ã‚¹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ========== ç¨¼åƒç‡è¡¨ç¤ºæ©Ÿèƒ½ ==========

        let operationRateChart = null;
        let deviceHourlyOperationChart = null;
        let currentDeviceAddr = null;
        let currentDeviceName = null;

        // ç¨¼åƒç‡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showOperationRate(deviceAddr, deviceName) {
            document.getElementById('operationRateTitle').textContent = `ç¨¼åƒç‡è¡¨ç¤º - ${deviceName}`;
            document.getElementById('operationRateDeviceAddr').value = deviceAddr;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“: éå»7æ—¥é–“
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            document.getElementById('modalOperationStartDate').value = formatDateLocal(sevenDaysAgo);
            document.getElementById('modalOperationEndDate').value = formatDateLocal(today);

            // çµæœã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            document.getElementById('operationRateResult').style.display = 'none';

            const modal = new bootstrap.Modal(document.getElementById('operationRateModal'));
            modal.show();
        }

        // ç¨¼åƒç‡ã‚’è¨ˆç®—
        async function calculateOperationRate() {
            const deviceAddr = document.getElementById('operationRateDeviceAddr').value;
            const startDate = document.getElementById('modalOperationStartDate').value;
            const endDate = document.getElementById('modalOperationEndDate').value;

            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }

            if (startDate > endDate) {
                alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                return;
            }

            try {
                const response = await fetch(
                    `/api/devices/${deviceAddr}/operation-rate?start_date=${startDate}&end_date=${endDate}`
                );

                if (!response.ok) {
                    const error = await response.json();
                    alert(`ã‚¨ãƒ©ãƒ¼: ${error.detail}`);
                    return;
                }

                const data = await response.json();

                // çµæœã‚’è¡¨ç¤º
                document.getElementById('operationRateValue').textContent = `${data.operation_rate}%`;

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                const total = data.total_minutes;
                const tableBody = document.getElementById('operationRateTable');
                tableBody.innerHTML = `
                    <tr>
                        <td><span class="badge bg-success">ç¨¼åƒï¼ˆç·‘ï¼‰</span></td>
                        <td>${data.operation_minutes.toLocaleString()} åˆ†</td>
                        <td>${((data.operation_minutes / total) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-warning">åœæ­¢ï¼ˆé»„ï¼‰</span></td>
                        <td>${data.stop_yellow_minutes.toLocaleString()} åˆ†</td>
                        <td>${((data.stop_yellow_minutes / total) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-danger">åœæ­¢ï¼ˆèµ¤ï¼‰</span></td>
                        <td>${data.stop_red_minutes.toLocaleString()} åˆ†</td>
                        <td>${((data.stop_red_minutes / total) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-secondary">æœªç¨¼åƒ</span></td>
                        <td>${data.none_minutes.toLocaleString()} åˆ†</td>
                        <td>${((data.none_minutes / total) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr class="fw-bold">
                        <td>åˆè¨ˆ</td>
                        <td>${total.toLocaleString()} åˆ†</td>
                        <td>100.0%</td>
                    </tr>
                `;

                // å††ã‚°ãƒ©ãƒ•ã‚’æç”»
                renderOperationRatePieChart(data);

                // çµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                document.getElementById('operationRateResult').style.display = 'block';

            } catch (error) {
                console.error('ç¨¼åƒç‡è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç¨¼åƒç‡ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å††ã‚°ãƒ©ãƒ•ã‚’æç”»
        function renderOperationRatePieChart(data) {
            const ctx = document.getElementById('operationRatePieChart').getContext('2d');

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (operationRateChart) {
                operationRateChart.destroy();
            }

            operationRateChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['ç¨¼åƒï¼ˆç·‘ï¼‰', 'åœæ­¢ï¼ˆé»„ï¼‰', 'åœæ­¢ï¼ˆèµ¤ï¼‰', 'æœªç¨¼åƒ'],
                    datasets: [{
                        data: [
                            data.operation_minutes,
                            data.stop_yellow_minutes,
                            data.stop_red_minutes,
                            data.none_minutes
                        ],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(108, 117, 125, 0.8)'
                        ],
                        borderColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545',
                            '#6c757d'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()}åˆ† (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========== è¨­å‚™ã”ã¨ã®æ™‚é–“å¸¯åˆ¥ç¨¼åƒç‡ ==========

        // æ™‚é–“å¸¯åˆ¥ç¨¼åƒç‡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDeviceHourlyOperation(deviceAddr, deviceName) {
            currentDeviceAddr = deviceAddr;
            currentDeviceName = deviceName;

            document.getElementById('deviceHourlyOperationTitle').textContent = `æ™‚é–“å¸¯åˆ¥ç¨¼åƒç‡ - ${deviceName}`;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®šï¼ˆ6:00ã‚ˆã‚Šå‰ãªã‚‰å‰æ—¥ï¼‰
            const now = new Date();
            const currentHour = now.getHours();
            const targetDate = new Date(now);
            if (currentHour < 6) {
                targetDate.setDate(targetDate.getDate() - 1);
            }
            document.getElementById('deviceHourlyDatePicker').value = formatDateLocal(targetDate);

            const modal = new bootstrap.Modal(document.getElementById('deviceHourlyOperationModal'));
            modal.show();

            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadDeviceHourlyData();
        }

        // æ™‚é–“å¸¯åˆ¥ç¨¼åƒç‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadDeviceHourlyData() {
            if (!currentDeviceAddr) return;

            const dateStr = document.getElementById('deviceHourlyDatePicker').value;
            if (!dateStr) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch(`/api/devices/${currentDeviceAddr}/hourly-operation-rate?date=${dateStr}`);
                if (!response.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }

                const data = await response.json();

                // ã‚°ãƒ©ãƒ•ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
                const ctx = document.getElementById('deviceHourlyOperationChart').getContext('2d');

                if (deviceHourlyOperationChart) {
                    deviceHourlyOperationChart.destroy();
                }

                // 24æ™‚é–“åˆ†ã®ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆ6:00ï½ç¿Œ5:00ï¼‰
                const allHours = [];
                for (let i = 0; i < 24; i++) {
                    const hour = (6 + i) % 24;
                    allHours.push(`${hour.toString().padStart(2, '0')}:00`);
                }

                // APIãƒ‡ãƒ¼ã‚¿ã‚’æ™‚é–“å¸¯ã”ã¨ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                const dataMap = {};
                data.data.forEach(d => {
                    dataMap[d.hour] = d;
                });

                // 24æ™‚é–“åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                const runningData = allHours.map(h => dataMap[h]?.running || 0);
                const stopYellowData = allHours.map(h => dataMap[h]?.stop_yellow || 0);
                const stopRedData = allHours.map(h => dataMap[h]?.stop_red || 0);
                const idleData = allHours.map(h => dataMap[h]?.idle || 0);

                deviceHourlyOperationChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: allHours,
                        datasets: [
                            {
                                label: 'ç¨¼åƒï¼ˆç·‘ï¼‰',
                                data: runningData,
                                backgroundColor: 'rgba(0, 255, 136, 0.7)',
                                borderColor: '#00ff88',
                                borderWidth: 1
                            },
                            {
                                label: 'åœæ­¢ï¼ˆé»„ï¼‰',
                                data: stopYellowData,
                                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                                borderColor: '#ffc107',
                                borderWidth: 1
                            },
                            {
                                label: 'åœæ­¢ï¼ˆèµ¤ï¼‰',
                                data: stopRedData,
                                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                                borderColor: '#dc3545',
                                borderWidth: 1
                            },
                            {
                                label: 'æœªç¨¼åƒ',
                                data: idleData,
                                backgroundColor: 'rgba(108, 117, 125, 0.7)',
                                borderColor: '#6c757d',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#00ffff'
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#00ffff',
                                    callback: function (value) {
                                        return value + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'ç¨¼åƒç‡ (%)',
                                    color: '#00ffff'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#ffffff',
                                    padding: 15
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('æ™‚é–“å¸¯åˆ¥ç¨¼åƒç‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ========== ç¾åœ¨ã®ç¨¼åƒç‡èª­ã¿è¾¼ã¿ ==========

        // ç¾åœ¨ã®ç¨¼åƒç‡ã‚’èª­ã¿è¾¼ã‚€ï¼ˆ6:00ã‹ã‚‰ç¾åœ¨ã¾ã§ï¼‰
        async function loadCurrentOperationRate(deviceAddr) {
            try {
                const response = await fetch(`/api/devices/${deviceAddr}/current-operation-rate`);
                const data = await response.json();

                if (response.ok) {
                    const rateValueElem = document.getElementById(`rate-value-${deviceAddr}`);
                    const rateDetailElem = document.getElementById(`rate-detail-${deviceAddr}`);

                    if (rateValueElem && rateDetailElem) {
                        rateValueElem.textContent = `${data.operation_rate}%`;

                        // ç¨¼åƒç‡ã«å¿œã˜ãŸè‰²åˆ†ã‘
                        rateValueElem.className = 'me-2';
                        if (data.operation_rate >= 80) {
                            rateValueElem.classList.add('text-success');
                        } else if (data.operation_rate >= 50) {
                            rateValueElem.classList.add('text-warning');
                        } else {
                            rateValueElem.classList.add('text-danger');
                        }

                        // è©³ç´°æƒ…å ±
                        const hours = Math.floor(data.operation_minutes / 60);
                        const mins = data.operation_minutes % 60;
                        const totalHours = Math.floor(data.total_minutes / 60);
                        const totalMins = data.total_minutes % 60;
                        rateDetailElem.textContent = `ç¨¼åƒ: ${hours}h ${mins}m / ${totalHours}h ${totalMins}m`;
                    }
                } else {
                    console.error('ç¨¼åƒç‡ã®å–å¾—ã«å¤±æ•—:', data);
                    const rateDetailElem = document.getElementById(`rate-detail-${deviceAddr}`);
                    if (rateDetailElem) {
                        rateDetailElem.textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                    }
                }
            } catch (error) {
                console.error('ç¨¼åƒç‡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const rateDetailElem = document.getElementById(`rate-detail-${deviceAddr}`);
                if (rateDetailElem) {
                    rateDetailElem.textContent = 'å–å¾—å¤±æ•—';
                }
            }
        }

        // ========== ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚°æ©Ÿèƒ½ ==========

        let currentLogDeviceAddr = '';

        // ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDataLogs(deviceAddr, deviceName) {
            currentLogDeviceAddr = deviceAddr;
            document.getElementById('dataLogsTitle').textContent = `ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚° - ${deviceName}`;

            const modal = new bootstrap.Modal(document.getElementById('dataLogsModal'));
            modal.show();

            // ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
            loadDataLogs(deviceAddr);
        }

        // ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
        async function loadDataLogs(deviceAddr) {
            try {
                const tableBody = document.getElementById('dataLogsTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="2" class="text-center">
                            <div class="spinner-border spinner-border-sm text-cyan" role="status">
                                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                            </div>
                        </td>
                    </tr>
                `;

                const response = await fetch(`/api/devices/${deviceAddr}/data-logs?limit=100`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('logCount').textContent = data.total_logs;

                    if (data.logs.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="2" class="text-center text-muted">
                                    ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    // ãƒ­ã‚°ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤º
                    tableBody.innerHTML = '';
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');

                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸãƒãƒƒã‚¸ã‚«ãƒ©ãƒ¼
                        let statusClass = 'status-idle';
                        if (log.green) statusClass = 'status-running';
                        else if (log.yellow) statusClass = 'status-warning';
                        else if (log.red) statusClass = 'status-stop';

                        row.innerHTML = `
                            <td>${log.timestamp}</td>
                            <td><span class="device-status-badge ${statusClass}">${log.status_text}</span></td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="2" class="text-center text-danger">
                                ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const tableBody = document.getElementById('dataLogsTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="2" class="text-center text-danger">
                            ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
                        </td>
                    </tr>
                `;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ­ã‚°ã‚’æ›´æ–°
        function refreshDataLogs() {
            if (currentLogDeviceAddr) {
                loadDataLogs(currentLogDeviceAddr);
            }
        }
    </script>
</body>

</html>