# ノートPCへの移行ガイド

システムが安定した後、24時間稼働用のノートPCに移行する手順です。

## 前提条件

- [ ] 現在のPCでシステムが正常動作している
- [ ] 使用していないノートPCがある
- [ ] ノートPCを同じWiFiネットワークに接続できる

## 重要な発見

現在のシステムは **WiFi接続で正常動作** しています。

- 現在のPC: WiFi接続、IP 192.168.0.231
- ESP32ゲートウェイ: 有線LAN、IP 192.168.0.55（自動取得）
- 両方とも 192.168.0.x ネットワークで通信

**ノートPCもWiFi接続で運用可能です！**

## 移行手順

### 1. ノートPCのネットワーク設定

現在のシステムは **WiFi接続（192.168.0.x ネットワーク）** で動作しています。

#### オプションA: WiFi自動IP取得（簡単）

ノートPCを同じWiFiに接続し、自動的にIPアドレスを取得します。

**手順:**
1. ノートPCを同じWiFiネットワークに接続
2. IPアドレスを確認：
   ```cmd
   ipconfig
   ```

   「ワイヤレス LAN アダプター Wi-Fi」セクションを確認

   例: `192.168.0.100` が割り当てられた場合

3. **ESP32の設定を変更**：
   ```cpp
   // main.cpp
   const char *mqtt_broker = "192.168.0.100";  // ノートPCのIP
   ```

4. ESP32に再度書き込み

#### オプションB: WiFi固定IP設定（推奨）

ノートPCのWiFi IPアドレスを固定することで、ESP32の再設定が不要になります。

**手順:**

1. **ノートPCのWiFi IPを現在のPCと同じにする**

   設定 → ネットワークとインターネット → WiFi → アダプターのオプションを変更する → WiFi → プロパティ → IPv4

   - IPアドレス: `192.168.0.231`
   - サブネットマスク: `255.255.254.0`
   - デフォルトゲートウェイ: `192.168.1.99`
   - 優先DNS: `8.8.8.8`

2. **ESP32の設定変更は不要**（既に `192.168.0.231` を指定しているため）

⚠️ **注意**: 現在のPCとノートPCを同時に起動しないでください（IPアドレスが重複します）

---

### 2. ノートPCへのソフトウェアインストール

#### 2-1. Python のインストール

1. https://www.python.org/downloads/ からPython 3.7以上をダウンロード
2. インストール時に「Add Python to PATH」をチェック

#### 2-2. Mosquitto のインストール

1. https://mosquitto.org/download/ からダウンロード
2. インストール後、サービスを開始：
   ```cmd
   net start mosquitto
   ```

#### 2-3. プロジェクトファイルのコピー

現在のPCからノートPCへファイルをコピーします。

**方法1: USBメモリで転送**
```
C:\Users\拓磨成尾\my_python_project\kado
```
フォルダ全体をコピー

**方法2: ネットワーク共有でコピー**
- 現在のPCでフォルダを共有
- ノートPCからアクセスしてコピー

#### 2-4. Python ライブラリのインストール

ノートPCで実行：
```cmd
cd C:\Users\<ノートPCのユーザー名>\my_python_project\kado
pip install -r requirements.txt
```

#### 2-5. データベースのコピー（オプション）

既存のデータを引き継ぐ場合：

現在のPCから `lighttower.db` をコピー：
```
C:\Users\拓磨成尾\my_python_project\kado\lighttower.db
```

ノートPCの同じフォルダに配置

---

### 3. 自動起動設定（24時間稼働用）

#### 3-1. Windows スタートアップに登録

**方法1: スタートアップフォルダに登録**

1. `Win + R` で `shell:startup` を実行
2. スタートアップフォルダが開く
3. `run_webapp.bat` のショートカットを作成して配置

**方法2: タスクスケジューラで登録（推奨）**

1. タスクスケジューラを開く
2. 「基本タスクの作成」
   - 名前: ライトタワー監視システム
   - トリガー: コンピューター起動時
   - 操作: プログラムの開始
   - プログラム: `C:\Users\<ユーザー名>\my_python_project\kado\run_webapp.bat`
3. 「完了」をクリック

#### 3-2. Mosquitto 自動起動の確認

Mosquittoはサービスとして自動起動します。確認：
```cmd
sc query mosquitto
```

`STATE : RUNNING` と表示されればOK

#### 3-3. 電源設定の変更

ノートPCがスリープしないように設定：

1. 設定 → システム → 電源とスリープ
2. 「次の時間が経過後、PCをスリープ状態にする」を「なし」に設定
3. 「カバーを閉じたときの動作」を「何もしない」に設定（蓋を閉じて運用する場合）

---

### 4. 動作確認

1. ノートPCを再起動
2. Webアプリが自動起動することを確認
3. ブラウザで `http://192.168.2.1:8000` にアクセス（または `http://localhost:8000`）
4. ESP32からデータが届くことを確認

---

### 5. 監視・メンテナンス

#### リモートアクセス（オプション）

社内の別のPCから監視する場合：

```
http://192.168.2.1:8000
```

にアクセス

#### ログ確認

Webアプリのコンソールでログを確認：
```cmd
cd C:\Users\<ユーザー名>\my_python_project\kado
python -m app.main
```

#### データベースバックアップ

定期的にバックアップ：
```cmd
copy lighttower.db lighttower_backup_%date:~0,4%%date:~5,2%%date:~8,2%.db
```

---

## トラブルシューティング

### ノートPCでWebアプリが起動しない

1. Pythonがインストールされているか確認：
   ```cmd
   python --version
   ```

2. ライブラリがインストールされているか確認：
   ```cmd
   pip list
   ```

3. エラーログを確認

### データが届かない

1. Mosquittoが起動しているか確認：
   ```cmd
   net start mosquitto
   ```

2. IPアドレスを確認：
   ```cmd
   ipconfig
   ```

3. ファイアウォール設定を確認：
   ```cmd
   netsh advfirewall firewall show rule name=all | findstr 1883
   ```

4. ESP32のシリアルモニターでMQTT接続状態を確認

### IPアドレスの競合

現在のPCとノートPCを同時に起動した場合：

1. 片方のPCをシャットダウン
2. もう片方のPCで `ipconfig /release` → `ipconfig /renew` を実行

---

## チェックリスト

### 移行前
- [ ] 現在のPCでシステムが安定動作している
- [ ] データベースをバックアップした
- [ ] ノートPCが有線LANに接続できる

### 移行中
- [ ] ノートPCのIPアドレスを設定した
- [ ] Python、Mosquittoをインストールした
- [ ] プロジェクトファイルをコピーした
- [ ] Pythonライブラリをインストールした
- [ ] ESP32の設定を変更した（必要な場合）

### 移行後
- [ ] Webアプリが起動する
- [ ] ESP32からデータが届く
- [ ] 自動起動が設定されている
- [ ] 電源設定を変更した

---

## 推奨設定まとめ

| 項目 | 設定値 |
|------|--------|
| ノートPC 接続方法 | WiFi（有線LAN不要） |
| ノートPC IP | `192.168.0.231`（固定推奨） |
| ネットワーク | 192.168.0.x（WiFiと同じ） |
| ESP32 mqtt_broker | `192.168.0.231` |
| Webアプリ MQTT_BROKER | `localhost` |
| 自動起動 | タスクスケジューラで設定 |
| 電源設定 | スリープなし |

---

移行に関する質問があれば、このガイドを参照してください。
