# ネットワークセットアップガイド

## 概要

ESP32ゲートウェイとPCの接続方法を説明します。直接接続する必要はなく、同じネットワーク（LAN）に接続されていれば動作します。

## 現在のネットワーク設定

ESP32ゲートウェイ（JP_LightTowerUpdate_LAN_1.4.0.ino）の設定：

```cpp
IPAddress myIP(192, 168, 2, 232);      // ゲートウェイのIP
IPAddress myGW(192, 168, 2, 1);        // デフォルトゲートウェイ
const char *mqtt_broker = "192.168.2.1";  // MQTTブローカーのIP
```

## 接続構成パターン

### パターン1: ルーター経由（推奨）

最も一般的な構成です。会社や自宅のルーターを使用します。

```
                  ┌──────────────┐
                  │  ルーター     │
                  │ 192.168.2.1  │
                  └──┬────────┬──┘
                     │        │
         ┌───────────┘        └──────────┐
         │                                │
    ┌────┴─────┐                   ┌─────┴────┐
    │ PC       │                   │ ESP32    │
    │ (MQTT)   │                   │ Gateway  │
    │ DHCP     │                   │ .2.232   │
    │ または    │                   │ (固定)   │
    │ 固定IP    │                   └──────────┘
    └──────────┘
```

**メリット:**
- 複数のPCからアクセス可能
- インターネット接続も維持
- 配線が柔軟

**必要な作業:**
1. PCのIPアドレス確認
2. MQTTブローカーのIP設定（必要に応じて）
3. ファイアウォール設定

---

### パターン2: PC直結（ルーターなし）

ルーターがない環境や、専用接続したい場合。

```
┌──────────┐  LANケーブル  ┌──────────┐
│    PC    │◄─────────────►│  ESP32   │
│ (MQTT)   │               │ Gateway  │
│ .2.1     │               │ .2.232   │
│ (固定)   │               │ (固定)   │
└──────────┘               └──────────┘
```

**メリット:**
- シンプルな構成
- ルーター不要
- セキュアな専用回線

**デメリット:**
- PCのネットワークアダプタが占有される
- インターネット接続に別のアダプタが必要

---

### パターン3: スイッチングハブ経由

複数のESP32ゲートウェイを接続する場合。

```
                  ┌──────────────┐
                  │スイッチング   │
                  │   ハブ       │
                  └──┬────┬───┬──┘
                     │    │   │
         ┌───────────┘    │   └──────────┐
         │                │              │
    ┌────┴─────┐   ┌─────┴────┐  ┌─────┴────┐
    │ PC       │   │ ESP32    │  │ ESP32    │
    │ .2.1     │   │ Gateway1 │  │ Gateway2 │
    │          │   │ .2.232   │  │ .2.233   │
    └──────────┘   └──────────┘  └──────────┘
```

**メリット:**
- 複数ゲートウェイ対応
- 拡張性が高い

---

## セットアップ手順

### ステップ1: PCのIPアドレス確認

コマンドプロンプトで実行：

```cmd
ipconfig
```

**出力例：**
```
イーサネット アダプター イーサネット:
   接続固有の DNS サフィックス . . . . .:
   リンクローカル IPv6 アドレス . . . . : fe80::xxxx:xxxx:xxxx:xxxx%12
   IPv4 アドレス . . . . . . . . . . . .: 192.168.2.100
   サブネット マスク . . . . . . . . . .: 255.255.255.0
   デフォルト ゲートウェイ . . . . . . .: 192.168.2.1
```

**確認ポイント:**
- IPv4アドレスが `192.168.2.x` であること
- デフォルトゲートウェイが `192.168.2.1` であること

### ステップ2: ケースに応じた設定

#### ケースA: PCのIPが既に192.168.2.x（例：192.168.2.100）

**やること:** ESP32ゲートウェイの設定変更

1. `JP_LightTowerUpdate_LAN_1.4.0.ino` を開く
2. 142行目を編集：

```cpp
// 修正前
const char *mqtt_broker = "192.168.2.1";

// 修正後
const char *mqtt_broker = "192.168.2.100";  // ← PCのIPに変更
```

3. ESP32に書き込む

#### ケースB: PCのIPを192.168.2.1に固定したい

**やること:** PCのネットワーク設定変更

1. コントロールパネル → ネットワークと共有センター
2. アダプターの設定変更
3. 使用するネットワークアダプタを右クリック → プロパティ
4. 「インターネット プロトコル バージョン 4 (TCP/IPv4)」を選択 → プロパティ
5. 以下を設定：
   - ○ 次のIPアドレスを使う
   - IPアドレス: `192.168.2.1`
   - サブネットマスク: `255.255.255.0`
   - デフォルトゲートウェイ: `192.168.2.1`（自分自身）
   - 優先DNSサーバー: `8.8.8.8`（Google DNS）
6. OKをクリック

**注意:** この設定にすると、PCがルーターとして機能します。ESP32のコード変更は不要です。

#### ケースC: PCのIPが全く違うネットワーク（例：192.168.1.x）

**やること1:** PCに2つ目のIPアドレスを追加（推奨）

1. コントロールパネル → ネットワークと共有センター
2. アダプターの設定変更
3. ネットワークアダプタ → プロパティ → IPv4 → プロパティ
4. 「詳細設定」をクリック
5. 「追加」をクリック
6. 以下を追加：
   - IPアドレス: `192.168.2.1`
   - サブネットマスク: `255.255.255.0`
7. OKで保存

これで、PCは元のネットワーク（192.168.1.x）とESP32のネットワーク（192.168.2.x）の両方に接続できます。

**やること2（別案）:** ESP32の全設定を変更

ESP32のIPアドレスをPCのネットワークに合わせる（上級者向け）。

### ステップ3: ファイアウォール設定

Windowsファイアウォールでポート1883を許可：

```cmd
netsh advfirewall firewall add rule name="Mosquitto MQTT" dir=in action=allow protocol=TCP localport=1883
```

### ステップ4: Mosquitto起動確認

```cmd
# Mosquittoサービス起動
net start mosquitto

# リッスン確認
netstat -ano | findstr :1883
```

**正常な出力例：**
```
TCP    0.0.0.0:1883           0.0.0.0:0              LISTENING       1234
```

### ステップ5: 接続テスト

#### テスト1: PCからMQTTブローカーに接続

```cmd
cd "C:\Program Files\mosquitto"
mosquitto_sub.exe -h localhost -t "lighttower/gateway/data" -v
```

このコマンドを実行したまま、ESP32の電源を入れます。

#### テスト2: ESP32ゲートウェイの接続確認

ESP32のシリアルモニタを開いて、以下のメッセージが出ることを確認：

```
Connected to MQTT server
GWI001
Light Tower Gateway
Copyright by Bui-Van Thanh
Version 1.4.1 (Development)
```

もし「failed, rc=-2」などのエラーが出る場合：
- `rc=-2`: MQTTブローカーに接続できない（IPアドレスが間違っている）
- `rc=-4`: 認証エラー（通常は発生しない）

## トラブルシューティング

### 問題1: ESP32がMQTTに接続できない

**症状:**
- ESP32のシリアルモニタに「failed, rc=-2」と表示
- Webアプリで「MQTT未接続」

**原因:**
- MQTTブローカーのIPアドレス設定が間違っている
- ファイアウォールがブロックしている
- Mosquittoが起動していない

**対処法:**

1. **Mosquittoの起動確認**
```cmd
net start mosquitto
netstat -ano | findstr :1883
```

2. **ファイアウォールの確認**
```cmd
# ルールを確認
netsh advfirewall firewall show rule name="Mosquitto MQTT"

# なければ追加
netsh advfirewall firewall add rule name="Mosquitto MQTT" dir=in action=allow protocol=TCP localport=1883
```

3. **IPアドレスの確認**
```cmd
ipconfig
```

PCのIPアドレスとESP32の`mqtt_broker`設定が一致しているか確認。

4. **一時的にファイアウォールを無効化してテスト**（問題切り分け用）
```cmd
# 注意：テスト後は必ず有効化すること
netsh advfirewall set allprofiles state off

# テスト後、有効化
netsh advfirewall set allprofiles state on
```

---

### 問題2: Pingは通るがMQTTに接続できない

**対処法:**

PCからESP32にPingを実行：
```cmd
ping 192.168.2.232
```

Pingが通る場合、ネットワークは正常です。

**確認事項:**
1. Mosquittoが0.0.0.0（すべてのインターフェース）でリッスンしているか

`C:\Program Files\mosquitto\mosquitto.conf` を確認：
```conf
listener 1883 0.0.0.0
allow_anonymous true
```

2. Mosquittoを再起動
```cmd
net stop mosquitto
net start mosquitto
```

---

### 問題3: データが届かない

**症状:**
- ESP32は接続成功と表示
- しかしWebアプリにデータが表示されない

**対処法:**

1. **MQTTメッセージを直接確認**
```cmd
cd "C:\Program Files\mosquitto"
mosquitto_sub.exe -h localhost -t "lighttower/#" -v
```

センサーからデータが来ると、ここに表示されるはずです。

2. **センサーが登録されているか確認**

`JP_LightTowerUpdate_LAN_1.4.0.ino` の37行目を確認：
```cpp
const String clientESP[7] = {
  "ECDA3BBE61E8", "B08184044C94", ...
};
```

センサーのMACアドレスがこの配列に含まれているか確認。

3. **センサーのバッテリー確認**

バッテリーが少ないとデータ送信しません。

---

### 問題4: 異なるネットワークからアクセスしたい

**例:** スマホ（192.168.1.x）からダッシュボード（192.168.2.1）にアクセス

**対処法:**

PCにルーティングを設定するか、2つのネットワークを統合します（上級者向け）。

または、PCのWebアプリを元のネットワーク（192.168.1.x）で起動し、ESP32の設定を変更します。

---

## よくある質問

### Q1: WiFiで接続できますか？

**A:** ESP32ゲートウェイは有線LAN（W5500）専用です。WiFiには対応していません。

### Q2: 複数のPCから同時にアクセスできますか？

**A:** はい。Webダッシュボードは複数のブラウザから同時にアクセス可能です。ただし、Mosquittoは1台のPCでのみ動作します。

### Q3: インターネット経由でアクセスできますか？

**A:** 現在の構成ではローカルネットワークのみです。インターネット経由でアクセスするには：
- VPN設定
- ポートフォワーディング（非推奨：セキュリティリスク）
- クラウドMQTTブローカーの使用（MQTT設定変更が必要）

### Q4: ルーターのIPアドレスが192.168.2.1でない場合は？

**A:** 以下の2つの方法があります：

**方法1:** ESP32の設定を変更（推奨）

すべてのIPアドレスをルーターのネットワークに合わせます。

例：ルーターが192.168.1.1の場合
```cpp
IPAddress myIP(192, 168, 1, 232);      // 変更
IPAddress myGW(192, 168, 1, 1);        // 変更
const char *mqtt_broker = "192.168.1.100";  // PCのIP
```

**方法2:** PCに2つ目のIPを追加

上記「ケースC」を参照。

---

## 推奨構成まとめ

### 小規模（1台のPC、1台のゲートウェイ）

```
PC（192.168.2.1）─── LAN ケーブル ───ESP32（192.168.2.232）
```

- PCのIPを192.168.2.1に固定
- ESP32のコード変更不要

### 中規模（既存ネットワークに追加）

```
ルーター（192.168.2.1）
    ├─ PC（DHCP または固定IP）
    └─ ESP32（192.168.2.232）
```

- ESP32の`mqtt_broker`をPCのIPに変更
- または、PCに192.168.2.1を追加

### 大規模（複数ゲートウェイ、複数PC）

```
ルーター（192.168.2.1）
    ├─ サーバーPC（192.168.2.10）← Mosquitto専用
    ├─ クライアントPC（DHCP）
    ├─ ESP32 Gateway 1（192.168.2.232）
    └─ ESP32 Gateway 2（192.168.2.233）
```

- 専用サーバーでMosquittoを動作
- 他のPCはブラウザでアクセス

---

## 設定チェックリスト

セットアップ前に確認：

- [ ] PCとESP32が同じネットワーク（192.168.2.x）にいる
- [ ] MQTTブローカーのIPアドレスが正しく設定されている
- [ ] Mosquittoが起動している（`net start mosquitto`）
- [ ] ファイアウォールでポート1883が許可されている
- [ ] PCとESP32が互いにPing可能

すべてチェックできたら、Webアプリを起動してテストしてください。
