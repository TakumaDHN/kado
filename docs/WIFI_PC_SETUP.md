# WiFi接続PC + 有線ESP32 セットアップガイド

## 概要

PCがWiFiでインターネットに接続している場合、有線LANポート（イーサネット）を使ってESP32ゲートウェイと接続できます。両方のネットワークを同時に使用可能です。

## システム構成

```
                 インターネット
                      │
                 ┌────┴────┐
                 │WiFiルーター│  ← 既存のインターネット接続
                 │192.168.1.1│
                 └─────────┘
                      │ WiFi
                      ▼
                 ┌──────────┐
                 │    PC    │
                 ├──────────┤
                 │ WiFi:    │  ← インターネット用
                 │ 192.168.1.100 (DHCP)
                 ├──────────┤
                 │ 有線LAN: │  ← ESP32専用
                 │ 192.168.2.1 (固定)
                 └────┬─────┘
                      │ LANケーブル
                 ┌────┴─────┐
                 │  ESP32   │
                 │ Gateway  │
                 │ 192.168.2.232 (固定)
                 └──────────┘
```

**メリット:**
- インターネット接続を維持したまま、ESP32と通信できる
- WiFiと有線LANが独立しているため干渉しない
- 簡単な設定のみで実現可能

## セットアップ手順

### ステップ1: ネットワークアダプタの確認

現在のネットワーク状態を確認します。

```cmd
ipconfig
```

**出力例：**
```
ワイヤレス LAN アダプター Wi-Fi:
   IPv4 アドレス . . . . . . . . . . . .: 192.168.1.100
   サブネット マスク . . . . . . . . . .: 255.255.255.0
   デフォルト ゲートウェイ . . . . . . .: 192.168.1.1

イーサネット アダプター イーサネット:
   メディアの状態 . . . . . . . . . . .: メディアは接続されていません
```

**確認ポイント:**
- WiFiアダプタ: インターネット接続中（192.168.1.x など）
- イーサネット: 未接続（これからESP32を接続）

---

### ステップ2: 有線LANアダプタに固定IPを設定

ESP32専用の有線LANポートに固定IPアドレスを設定します。

#### 手順（Windows 10/11）

1. **スタートメニュー** → 「コントロールパネル」を検索して開く

2. **ネットワークと共有センター** をクリック

3. 左側の **アダプターの設定変更** をクリック

4. **イーサネット**（または「ローカルエリア接続」）を右クリック → **プロパティ**

5. **インターネット プロトコル バージョン 4 (TCP/IPv4)** を選択 → **プロパティ**

6. 以下のように設定：

```
○ 次のIPアドレスを使う

IPアドレス:           192.168.2.1
サブネットマスク:     255.255.255.0
デフォルトゲートウェイ: (空欄のまま)

○ 次のDNSサーバーのアドレスを使う

優先DNSサーバー:      (空欄のまま)
代替DNSサーバー:      (空欄のまま)
```

**重要:**
- デフォルトゲートウェイは**空欄**にします（WiFiのゲートウェイと競合させない）
- DNSサーバーも**空欄**にします（WiFi側のDNSを使用）

7. **OK** をクリックして保存

8. もう一度 **OK** をクリックしてプロパティを閉じる

---

### ステップ3: ESP32をLANケーブルで接続

1. PCの有線LANポートとESP32ゲートウェイをLANケーブルで接続

2. ESP32の電源を入れる

3. 接続確認：

```cmd
ipconfig
```

**正常な出力例：**
```
イーサネット アダプター イーサネット:
   接続固有の DNS サフィックス . . . . .:
   IPv4 アドレス . . . . . . . . . . . .: 192.168.2.1
   サブネット マスク . . . . . . . . . .: 255.255.255.0
   デフォルト ゲートウェイ . . . . . . .:
```

4. ESP32にPing:

```cmd
ping 192.168.2.232
```

**正常な出力：**
```
192.168.2.232 に ping を送信しています 32 バイトのデータ:
192.168.2.232 からの応答: バイト数 =32 時間 <1ms TTL=64
192.168.2.232 からの応答: バイト数 =32 時間 <1ms TTL=64
```

---

### ステップ4: Mosquittoの設定確認

Mosquittoが**すべてのネットワークインターフェース**でリッスンしているか確認します。

#### 設定ファイルの確認

`C:\Program Files\mosquitto\mosquitto.conf` を開いて以下を確認：

```conf
listener 1883 0.0.0.0
allow_anonymous true
```

**重要:** `0.0.0.0` は「すべてのネットワークアダプタ」を意味します。これにより、WiFi側と有線LAN側の両方でMQTTが使えます。

#### Mosquittoの再起動

設定を変更した場合は、サービスを再起動：

```cmd
net stop mosquitto
net start mosquitto
```

#### リッスン状態の確認

```cmd
netstat -ano | findstr :1883
```

**正常な出力：**
```
TCP    0.0.0.0:1883           0.0.0.0:0              LISTENING       1234
```

`0.0.0.0` になっていれば、すべてのアダプタでリッスンしています。

---

### ステップ5: ファイアウォール設定

Windowsファイアウォールでポート1883を許可：

```cmd
netsh advfirewall firewall add rule name="Mosquitto MQTT" dir=in action=allow protocol=TCP localport=1883
```

---

### ステップ6: 動作確認

#### テスト1: MQTTメッセージ受信

```cmd
cd "C:\Program Files\mosquitto"
mosquitto_sub.exe -h localhost -t "lighttower/gateway/data" -v
```

このコマンドを実行したまま、ESP32からデータが来るのを待ちます。

#### テスト2: Webアプリ起動

```cmd
cd C:\Users\拓磨成尾\my_python_project\kado
run_webapp.bat
```

ブラウザで http://localhost:8000 にアクセス

---

## トラブルシューティング

### 問題1: ESP32にPingが通らない

**症状:**
```
ping 192.168.2.232
要求がタイムアウトしました。
```

**原因と対処法:**

1. **LANケーブルの接続確認**
   - ケーブルがしっかり接続されているか
   - LANポートのLEDが点灯/点滅しているか

2. **ESP32の起動確認**
   - 電源が入っているか
   - シリアルモニタで起動メッセージを確認

3. **PCのイーサネットアダプタの状態確認**
```cmd
ipconfig /all
```

「メディアは接続されていません」と表示される場合、物理的な接続に問題があります。

4. **クロスケーブル vs ストレートケーブル**

最近のデバイスは自動判別（Auto-MDIX）機能があるため、どちらのケーブルでも動作しますが、古いPCの場合はクロスケーブルが必要な場合があります。

---

### 問題2: インターネット接続が切れた

**症状:**
有線LANの設定後、WiFi経由のインターネット接続ができなくなった。

**原因:**
デフォルトゲートウェイが有線LAN側に設定されている。

**対処法:**

1. 有線LANの設定を確認（ステップ2参照）
2. デフォルトゲートウェイが**空欄**になっているか確認
3. 以下のコマンドで優先順位を確認：

```cmd
route print
```

**正常な状態:**
```
アクティブ ルート:
ネットワーク宛先    ネットマスク  ゲートウェイ  インターフェイス  メトリック
          0.0.0.0          0.0.0.0  192.168.1.1  192.168.1.100      25  ← WiFi（低い=優先）
    192.168.2.0    255.255.255.0        直接接続  192.168.2.1      281  ← 有線LAN
```

メトリック値が低い方が優先されます。WiFi側のメトリックが低ければ正常です。

**手動で優先順位を設定する場合:**

1. ネットワークアダプタのプロパティ → IPv4 → プロパティ → 詳細設定
2. 「自動メトリック」のチェックを外す
3. インターフェイス メトリック:
   - WiFi: `10`（小さい値=優先）
   - 有線LAN: `100`（大きい値=低優先）

---

### 問題3: WiFi側からWebダッシュボードにアクセスできない

**症状:**
- ESP32とは通信できる
- しかし、スマホやタブレット（WiFi接続）からダッシュボードにアクセスできない

**原因:**
Webアプリが `localhost` でのみリッスンしている。

**対処法:**

Webアプリ起動時に `0.0.0.0` でリッスン（既に設定済み）：

```cmd
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

これで、WiFi側のIPアドレス（例：192.168.1.100）でもアクセス可能になります：

- PCから: http://localhost:8000
- スマホから: http://192.168.1.100:8000

**ファイアウォール設定（必要に応じて）:**
```cmd
netsh advfirewall firewall add rule name="FastAPI Web" dir=in action=allow protocol=TCP localport=8000
```

---

### 問題4: ESP32がMQTTに接続できない

**症状:**
ESP32のシリアルモニタに「failed, rc=-2」と表示

**原因:**
MQTTブローカーのIPアドレス設定が間違っている。

**対処法:**

ESP32のコードを確認：

```cpp
// JP_LightTowerUpdate_LAN_1.4.0.ino 142行目
const char *mqtt_broker = "192.168.2.1";  // ← PCの有線LAN IP
```

これが正しいことを確認。PCの有線LANのIPは `192.168.2.1` に設定したので、このままでOKです。

もし変更した場合は、ESP32に再度書き込みます。

---

## ネットワークルーティングの仕組み

PCは2つのネットワークに接続されています：

```
PC のルーティングテーブル:

宛先             ゲートウェイ    インターフェース     用途
0.0.0.0/0        192.168.1.1    WiFi (192.168.1.100)  ← インターネット全般
192.168.2.0/24   直接接続       LAN (192.168.2.1)     ← ESP32専用
```

**動作:**
- インターネットへの通信 → WiFi経由
- 192.168.2.x への通信 → 有線LAN経由
- localhost への通信 → ローカル

これにより、両方のネットワークが共存できます。

---

## よくある質問

### Q1: WiFiルーターと有線LANを同じネットワーク（192.168.1.x）にできますか？

**A:** できますが、推奨しません。

理由：
- IPアドレスの競合リスク
- ルーティングが複雑になる
- トラブルシューティングが困難

別々のネットワーク（WiFi: 192.168.1.x、有線: 192.168.2.x）が簡単です。

---

### Q2: スマホからダッシュボードを見たい

**A:** 可能です。

1. PCのWiFi側IPアドレスを確認（例：192.168.1.100）
2. スマホのブラウザで `http://192.168.1.100:8000` にアクセス
3. ファイアウォールでポート8000を許可（上記参照）

---

### Q3: PCを再起動すると設定が消えますか？

**A:** いいえ、設定は保存されます。

ただし、以下は再起動後に再度実行が必要：
- Mosquittoサービスの起動（自動起動に設定すれば不要）
- Webアプリの起動

---

### Q4: 有線LANポートがない場合は？

**A:** USB-LANアダプタを使用できます。

Amazonなどで「USB イーサネット アダプタ」を購入し、PCに接続。同じ手順でIPアドレスを設定します。

---

### Q5: WiFiルーターを経由してESP32を接続できますか？

**A:** ESP32ゲートウェイは有線LAN専用のため、WiFiルーターに直接接続する必要があります。

**構成例：**
```
WiFiルーター（192.168.1.1）
    ├─ PC（WiFi: 192.168.1.100）
    └─ ESP32（有線LAN: 192.168.1.232）
```

この場合、ESP32のIPアドレスをWiFiルーターのネットワーク（192.168.1.x）に変更する必要があります：

```cpp
// ESP32のコードを変更
IPAddress myIP(192, 168, 1, 232);      // 変更
IPAddress myGW(192, 168, 1, 1);        // 変更
const char *mqtt_broker = "192.168.1.100";  // PCのWiFi IP
```

---

## 設定チェックリスト

- [ ] PCの有線LANポートに固定IP（192.168.2.1）を設定
- [ ] デフォルトゲートウェイは空欄
- [ ] ESP32とLANケーブルで接続
- [ ] ESP32にPingが通る（`ping 192.168.2.232`）
- [ ] Mosquittoが起動中（`net start mosquitto`）
- [ ] Mosquittoが0.0.0.0でリッスン（`netstat -ano | findstr :1883`）
- [ ] ファイアウォールでポート1883を許可
- [ ] WiFi接続は維持されている
- [ ] インターネット接続が正常

すべてチェックできたら、Webアプリを起動してテストしてください。

---

## まとめ

PCがWiFiでインターネット接続していても、有線LANポートを使ってESP32と接続できます。

**ポイント:**
- WiFi: インターネット用（192.168.1.x）
- 有線LAN: ESP32専用（192.168.2.x）
- 両方のネットワークが同時に動作
- デフォルトゲートウェイは有線LAN側に設定しない

この構成なら、インターネットを使いながらESP32の監視ができます。
